<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat-container { width: 500px; margin: auto; }
        #chat-box { width: 100%; height: 300px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; background: #f9f9f9; }
        .message { margin: 5px 0; padding: 8px; border-radius: 5px; max-width: 80%; display: inline-block; }
        .my-message { background-color: #d1e7dd; text-align: right; }
        .other-message { background-color: #f8d7da; text-align: left; }
        .system-message { background-color: #e7e7e7; font-style: italic; text-align: center; }
        .chat-room-btn { padding: 10px; margin: 5px; border: none; cursor: pointer; background-color: lightgray; width: 100%; text-align: left; }
        .chat-room-btn.selected { background-color: lightblue; }
    </style>
</head>
<body>

    <div id="chat-container">
        <h2>WebSocket ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>

        <h3>íšŒì›ê°€ì…</h3>
        <input type="text" id="signupEmail" placeholder="ì´ë©”ì¼ ì…ë ¥">
        <button onclick="signup()">íšŒì›ê°€ì…</button>
        <p id="signupResult"></p>

        <h3>ë¡œê·¸ì¸</h3>
        <input type="text" id="loginEmail" placeholder="ì´ë©”ì¼ ì…ë ¥">
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <p id="loginResult"></p>

        <h3>ì±„íŒ…ë°© ê´€ë¦¬</h3>
        <button onclick="loadChatRooms()">ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="createChatRoom()">ì±„íŒ…ë°© ìƒì„±</button>
        <input type="text" id="otherUserId" placeholder="ìƒëŒ€ë°© ID ì…ë ¥">
        <button onclick="leaveChatRoom()">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>

        <h4>ì±„íŒ…ë°© ëª©ë¡</h4>
        <div id="chatRoomList"></div>

        <h4>í˜„ì¬ ì±„íŒ…ë°©</h4>
        <p id="currentRoom">ì„ íƒëœ ì±„íŒ…ë°©: ì—†ìŒ</p>

        <button onclick="connectWebSocket()">ì›¹ì†Œì¼“ ì—°ê²°</button>
        <p id="status">ì—°ê²° ìƒíƒœ: ëŠê¹€</p>

        <div id="chat-box"></div>
        <div>
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="sendMessage()">ì „ì†¡</button>
        </div>

        <h3>ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡</h3>
<input type="text" id="targetUserId" placeholder="ë°›ì„ ìœ ì € ID ì…ë ¥">
<input type="text" id="systemMessageInput" placeholder="ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì…ë ¥">
<button onclick="sendSystemMessageToUser()">ìœ ì €ì—ê²Œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡</button>
<br><br>
<button onclick="sendSystemMessageToRoom()">ì±„íŒ…ë°©ì— ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡</button>

    </div>

    <script>
        let stompClient = null;
        let accessToken = localStorage.getItem("accessToken");
        let userId = localStorage.getItem("userId");
        let selectedRoomId = null;

        function signup() {
            const email = document.getElementById("signupEmail").value;
            fetch("https://i12a309.p.ssafy.io/auth/sign-up", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.text())
            .then(() => document.getElementById("signupResult").innerText = "íšŒì›ê°€ì… ì„±ê³µ!")
            .catch(error => console.error("íšŒì›ê°€ì… ì˜¤ë¥˜:", error));
        }

        function login() {
            const email = document.getElementById("loginEmail").value;
            fetch("https://i12a309.p.ssafy.io/auth/sign-in", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.accessToken) {
                    accessToken = data.accessToken;
                    userId = data.userId;
                    localStorage.setItem("accessToken", accessToken);
                    localStorage.setItem("userId", userId);
                    document.getElementById("loginResult").innerText = "ë¡œê·¸ì¸ ì„±ê³µ!";
                }
            })
            .catch(error => console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error));
        }

        function createChatRoom() {
            const otherUserId = document.getElementById("otherUserId").value;
            fetch(`https://i12a309.p.ssafy.io/chat-rooms/create?otherMemberId=${otherUserId}`, {
                method: "POST",
                headers: { "Authorization": "Bearer " + accessToken, "Content-Type": "application/json" }
            })
            .then(response => response.json())
            .then(room => {
                console.log("âœ… ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ:", room);
                loadChatRooms();
            })
            .catch(error => console.error("âŒ ì±„íŒ…ë°© ìƒì„± ì˜¤ë¥˜:", error));
        }

        // function loadChatRooms() {
        //     fetch("http://localhost:8080/chat-room/list", {
        //         method: "GET",
        //         headers: { Authorization: "Bearer " + accessToken }
        //     })
        //     .then(response => response.json())
        //     .then(rooms => {
        //         const chatRoomList = document.getElementById("chatRoomList");
        //         chatRoomList.innerHTML = "";
        //         rooms.forEach(room => {
        //             const btn = document.createElement("button");
        //             btn.textContent = `ì±„íŒ…ë°© ${room.id}`;
        //             btn.classList.add("chat-room-btn");
        //             btn.onclick = () => selectChatRoom(room.id, btn);
        //             chatRoomList.appendChild(btn);
        //         });
        //     })
        //     .catch(error => console.error("ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
        // }
        function loadChatRooms() {
    fetch("https://i12a309.p.ssafy.io/chat-rooms/list", {
        method: "GET",
        headers: { Authorization: "Bearer " + accessToken }
    })
    .then(response => response.json())  // JSON ë³€í™˜
    .then(rooms => {
        console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ í™•ì¸:", rooms);  // ì‘ë‹µ í™•ì¸
        if (!Array.isArray(rooms)) {
            console.error("ğŸš¨ ì˜¤ë¥˜: ì„œë²„ì—ì„œ ë°˜í™˜ëœ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", rooms);
            return;
        }

        const chatRoomList = document.getElementById("chatRoomList");
        chatRoomList.innerHTML = "";
        rooms.forEach(room => {
            const btn = document.createElement("button");
            btn.textContent = `ì±„íŒ…ë°© ${room.id}`;
            btn.classList.add("chat-room-btn");
            btn.onclick = () => selectChatRoom(room.id, btn);
            chatRoomList.appendChild(btn);
        });
    })
    .catch(error => console.error("ğŸš¨ ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
}


        function leaveChatRoom() {
            fetch(`https://i12a309.p.ssafy.io/chat-rooms/leave/${selectedRoomId}`, {
                method: "POST",
                headers: { Authorization: "Bearer " + accessToken }
            })
            .then(() => {
                alert("ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                loadChatRooms();
            })
            .catch(error => console.error("ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì˜¤ë¥˜:", error));
        }

        function selectChatRoom(roomId, button) {
    selectedRoomId = roomId;
    document.getElementById("currentRoom").innerText = `ì„ íƒëœ ì±„íŒ…ë°©: ${roomId}`;
    
    document.querySelectorAll(".chat-room-btn").forEach(btn => btn.classList.remove("selected"));
    button.classList.add("selected");

    console.log(`âœ… ì±„íŒ…ë°©(${roomId})ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ì´ì „ ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.`);

    // âœ… ì±„íŒ…ë°© ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    loadChatRoomMessages(roomId);

    // âœ… WebSocket êµ¬ë…
    if (stompClient && stompClient.connected) {
        subscribeToRoom(roomId);
    }
}

function loadChatRoomMessages(roomId) {
    console.log(`ğŸ“Œ [DEBUG] ì±„íŒ…ë°©(${roomId})ì˜ ì´ì „ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤...`);

    fetch(`https://i12a309.p.ssafy.io/chat-rooms/message?roomId=${roomId}`, {
        method: "GET",
        headers: { "Authorization": "Bearer " + accessToken }
    })
    .then(response => response.json())
    .then(messages => {
        console.log(`ğŸ“© [DEBUG] ì„œë²„ ì‘ë‹µ:`, messages);

        if (!Array.isArray(messages)) {
            console.error("ğŸš¨ [ERROR] ì„œë²„ì—ì„œ ë°˜í™˜ëœ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", messages);
            return;
        }

        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = ""; // ê¸°ì¡´ ë©”ì‹œì§€ ì´ˆê¸°í™”

        messages.forEach(msg => {
            console.log(`ğŸ’¬ [DEBUG] ë©”ì‹œì§€ ì¶”ê°€: ${msg.senderId}: ${msg.content}`);
            displayMessage(msg);
        });

        console.log("âœ… [DEBUG] ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì™„ë£Œ!");
    })
    .catch(error => console.error("âŒ [ERROR] ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
}



        // function selectChatRoom(roomId, button) {
        //     selectedRoomId = roomId;
        //     document.getElementById("currentRoom").innerText = `ì„ íƒëœ ì±„íŒ…ë°©: ${roomId}`;
        //     document.querySelectorAll(".chat-room-btn").forEach(btn => btn.classList.remove("selected"));
        //     button.classList.add("selected");

        //     if (stompClient && stompClient.connected) {
        //         subscribeToRoom(roomId);
        //     }
        // }

//         function subscribeToRoom(roomId) {
//     if (!stompClient || !stompClient.connected) {
//         console.error("ğŸš¨ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•„ ì±„íŒ…ë°©ì„ êµ¬ë…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
//         return;
//     }

//     let roomSubscription = `/topic/chat-room/${roomId}`;
//     console.log(`ğŸ“¡ [WebSocket] ì±„íŒ…ë°© êµ¬ë… ì‹œë„: ${roomSubscription}`);

//     stompClient.subscribe(roomSubscription, function (message) {
//         const msgData = JSON.parse(message.body);
//         console.log("ğŸ“© [WebSocket] ìˆ˜ì‹ í•œ ë©”ì‹œì§€:", msgData);
//         displayMessage(msgData);
//     }, { Authorization: "Bearer " + accessToken });
// }

function subscribeToRoom(roomId) {
    if (!stompClient || !stompClient.connected) {
        console.error("ğŸš¨ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•„ ì±„íŒ…ë°©ì„ êµ¬ë…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    let roomSubscription = `/topic/chat-room/${roomId}`;
    console.log(`ğŸ“¡ [WebSocket] ì±„íŒ…ë°© êµ¬ë… ì‹œë„: ${roomSubscription}`);

    stompClient.subscribe(roomSubscription, function (message) {
        console.log("ğŸ“© [WebSocket] ìˆ˜ì‹ í•œ ë©”ì‹œì§€ ì›ë³¸:", message); // JSON ë³€í™˜ ì „ ì›ë³¸ ë°ì´í„°

        try {
            const msgData = JSON.parse(message.body);
            console.log("ğŸ“© [WebSocket] íŒŒì‹±ëœ ë©”ì‹œì§€:", msgData);
            console.log("ğŸ›  displayMessage() í˜¸ì¶œ ì „ ë°ì´í„°:", msgData);
            displayMessage(msgData);
        } catch (error) {
            console.error("ğŸš¨ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", error);
        }
    }, { Authorization: "Bearer " + accessToken });
}




        function connectWebSocket() {
            const socket = new SockJS("https://i12a309.p.ssafy.io/ws-chat");
stompClient = Stomp.over(socket);

const headers = { Authorization: "Bearer " + accessToken };

stompClient.connect(headers, function () {
    console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ!");
    document.getElementById("status").innerText = "ì—°ê²° ìƒíƒœ: ì—°ê²°ë¨";
}, function (error) {
    console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
});

        }

        function sendMessage() {
    if (!stompClient || !stompClient.connected) {
        console.error("ğŸš¨ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    if (!selectedRoomId) {
        console.error("ğŸš¨ ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        console.log("í˜„ì¬ selectedRoomId ê°’:", selectedRoomId);
        return;
    }

    const message = document.getElementById("messageInput").value;
    if (!message.trim()) {
        console.warn("âš ï¸ ë¹ˆ ë©”ì‹œì§€ëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const payload = JSON.stringify({ roomId: selectedRoomId, content: message });

    console.log("ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„:", payload);

    stompClient.send(`/app/chat-room/${selectedRoomId}`, { Authorization: "Bearer " + accessToken }, payload);

    document.getElementById("messageInput").value = "";
}

// âœ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function displayMessage(message) {
    console.log("ğŸ’¬ [UI ì—…ë°ì´íŠ¸] ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€:", message);

    const chatBox = document.getElementById("chat-box");
    const newMessage = document.createElement("div");
    newMessage.classList.add("message");

    // âœ… ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬ (senderId ë˜ëŠ” receiverIdê°€ 0ì¼ ê²½ìš°)
    if (message.senderId == 0 || message.receiverId == 0) {
        newMessage.classList.add("system-message");
        newMessage.innerText = `[SYSTEM] ${message.content}`;
    } 
    // âœ… ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€
    else if (message.senderId == userId) {
        newMessage.classList.add("my-message");
        newMessage.innerText = `(${message.senderId}): ${message.content}`;
    } 
    // âœ… ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€
    else {
        newMessage.classList.add("other-message");
        newMessage.innerText = `(${message.senderId}): ${message.content}`;
    }

    chatBox.appendChild(newMessage);
    chatBox.scrollTop = chatBox.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
}

// function displayMessage(message) {
//     console.log("ğŸ’¬ [UI ì—…ë°ì´íŠ¸] ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€:", message);

//     if (!message || !message.senderId || !message.content) {
//         console.error("ğŸš¨ ë©”ì‹œì§€ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", message);
//         return;
//     }

//     const chatBox = document.getElementById("chat-box");
//     const newMessage = document.createElement("div");
//     newMessage.classList.add("message");

//     if (message.senderId == userId) {
//         newMessage.classList.add("my-message");
//     } else if (message.messageType === "SYSTEM") {
//         newMessage.classList.add("system-message");
//     } else {
//         newMessage.classList.add("other-message");
//     }

//     console.log("ğŸ›  [UI] ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì ìš© ì™„ë£Œ");

//     newMessage.innerText = `(${message.senderId}): ${message.content}`;
//     chatBox.appendChild(newMessage);
//     chatBox.scrollTop = chatBox.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤

//     console.log("âœ… [UI] ë©”ì‹œì§€ ì¶”ê°€ ì™„ë£Œ");
// }


// âœ… íŠ¹ì • ìœ ì €ì—ê²Œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ (ê´€ë¦¬ì â†’ íŠ¹ì • ìœ ì €)
function sendSystemMessageToUser() {
    const receiverId = document.getElementById("targetUserId").value;
    const messageContent = document.getElementById("systemMessageInput").value;

    if (!receiverId || !messageContent) {
        console.error("ğŸš¨ ìˆ˜ì‹ ì IDì™€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    const payload = {
        receiverId: parseInt(receiverId),
        senderId: 0, // ì‹œìŠ¤í…œ(ê´€ë¦¬ì)ì—ì„œ ë³´ë‚´ëŠ” ê²½ìš° 0
        content: messageContent
    };

    fetch("https://i12a309.p.ssafy.io/chat-messages/system/member", {
        method: "POST",
        headers: { "Authorization": "Bearer " + accessToken, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(response => response.text())
    .then(data => {
        console.log("âœ… íŠ¹ì • ìœ ì €ì—ê²Œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ:", data);
    })
    .catch(error => console.error("âŒ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:", error));
}

// âœ… ì±„íŒ…ë°©ì— ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡
function sendSystemMessageToRoom() {
    if (!selectedRoomId) {
        console.error("ğŸš¨ ì±„íŒ…ë°©ì„ ë¨¼ì € ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    const messageContent = document.getElementById("systemMessageInput").value;
    if (!messageContent) {
        console.error("ğŸš¨ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    const payload = {
        roomId: selectedRoomId,
        senderId: 0, // ì‹œìŠ¤í…œ ë©”ì‹œì§€ì´ë¯€ë¡œ 0
        content: messageContent
    };

    fetch("https://i12a309.p.ssafy.io/chat-messages/system/room", {
        method: "POST",
        headers: { "Authorization": "Bearer " + accessToken, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(response => response.text())
    .then(data => {
        console.log("âœ… ì±„íŒ…ë°©ì— ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ:", data);
    })
    .catch(error => console.error("âŒ ì±„íŒ…ë°© ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:", error));
}

    </script>

</body>
</html>